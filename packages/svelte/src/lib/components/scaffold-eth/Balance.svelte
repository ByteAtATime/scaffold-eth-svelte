<script lang="ts">
  import { createTargetNetwork } from "$lib/runes/targetNetwork.svelte";
  import { createBlockNumber, createBalance } from "@byteatatime/wagmi-svelte";
  import { useQueryClient } from "@tanstack/svelte-query";
  import { formatEther, type Address } from "viem";
  import { nativeCurrencyPrice } from "$lib/runes/global.svelte";
  import { untrack } from "svelte";

  const {
    address,
    class: className = "",
    usdMode = false,
  }: { address?: Address; class?: string; usdMode?: boolean } = $props();

  const { targetNetwork } = $derived(createTargetNetwork());

  const queryClient = useQueryClient();
  // eslint-disable-next-line svelte/valid-compile
  const blockNumber = createBlockNumber({ watch: true, chainId: targetNetwork.id });
  // We update this in the effect below
  // eslint-disable-next-line svelte/valid-compile
  let balance = $state(createBalance({ address, chainId: targetNetwork.id }));

  $effect(() => {
    blockNumber.result.data;
    queryClient;

    untrack(() => {
      queryClient.invalidateQueries({ queryKey: balance.result.queryKey });
    });
  });

  $effect(() => {
    balance = createBalance({ address, chainId: targetNetwork.id });
  });

  const formattedBalance = $derived(balance.result.data ? Number(formatEther(balance.result.data.value)) : 0);

  let displayUsdMode = $state(nativeCurrencyPrice.price > 0 ? Boolean(usdMode) : false);

  const toggleBalanceMode = () => {
    if (nativeCurrencyPrice.price > 0) {
      displayUsdMode = !displayUsdMode;
    }
  };
</script>

{#if balance.result.isLoading}
  <div class="flex animate-pulse space-x-4">
    <div class="h-6 w-6 rounded-md bg-slate-300"></div>
    <div class="flex items-center space-y-6">
      <div class="h-2 w-28 rounded bg-slate-300"></div>
    </div>
  </div>
{:else if balance.result.isError}
  <div class="flex max-w-fit cursor-pointer flex-col items-center rounded-md border-2 border-gray-400 px-2">
    <div class="text-warning">Error</div>
  </div>
{:else}
  <button
    class={`btn btn-ghost btn-sm flex flex-col items-center font-normal hover:bg-transparent ${className}`}
    on:click={toggleBalanceMode}
  >
    <div class="flex w-full items-center justify-center">
      {#if displayUsdMode}
        <span class="mr-1 text-[0.8em] font-bold">$</span>
        <span>{(formattedBalance * nativeCurrencyPrice.price).toFixed(2)}</span>
      {:else}
        <span>{formattedBalance.toFixed(4)}</span>
        <span class="ml-1 text-[0.8em] font-bold">{targetNetwork.nativeCurrency.symbol}</span>
      {/if}
    </div>
  </button>
{/if}
